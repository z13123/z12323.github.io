<html></html>
<head>
    <title>Price Monitor</title>
    <style>
        #output {
            font-family: monospace;
            background-color: #f5f5f5;
            padding: 10px;
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</head>
<body>
    <h2>价格监控</h2>
    <div id="output"></div>

    <script>
        const outputDiv = document.getElementById('output');
        const THE_ADDRESS = "0xf4c8e32eadec4bfe97e0f595add0f4450a863a11";
        const LIVE_ADDRESS = "0xcdc3a010a3473c0c4b2cb03d8489d6ba387b83cd";
        const CHAIN_ID = 56;

        function addLog(message) {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.textContent = message;
            outputDiv.appendChild(logEntry);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        async function getTokenPrice(tokenAddress) {
            try {
                const response = await fetch(`https://api.odos.xyz/pricing/token/${CHAIN_ID}/${tokenAddress}`);
                if (response.ok) {
                    const data = await response.json();
                    return data.price;
                } else {
                    console.error("Error getting token price:", await response.text());
                    return null;
                }
            } catch (error) {
                console.error("Failed to fetch token price:", error);
                return null;
            }
        }



        async function checkPrice() {
            try {
                const thePrice = await getTokenPrice(THE_ADDRESS);
                const livePrice = await getTokenPrice(LIVE_ADDRESS);

                if (thePrice && livePrice) {
                    // 使用字符串计算以保持精度
                    const ratio = (Number(thePrice) / Number(livePrice)).toFixed(6);
                    
                    // 更新页面标题
                    document.title = `${ratio}`;

                    const now = new Date().toLocaleString();
                    const logMessage = `===== 兑换比例 ${now} =====\n1 THE = ${ratio} liveTHE`;
                    
                    addLog(logMessage);
                    console.log(logMessage);

                    if (Number(ratio) <= 1.8) {
                        const alertMessage = `the价格低于1.8倍, 当前为：${ratio}`;
                        addLog(alertMessage);
             
                    }
                }
            } catch (error) {
                addLog('错误: ' + error);
                console.error(error);
            }
        }

        // 每3秒执行一次
        setInterval(checkPrice, 3000);
        // 立即执行一次
        checkPrice();
    </script>
</body>
</html>
